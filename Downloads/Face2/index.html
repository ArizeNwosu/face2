<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Photo Suite Anonymizer - Medical Aesthetics Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        medical: {
                            50: '#3AAFA9',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom slider styles */
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            border: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .slider {
            background: rgb(226, 232, 240);
        }
        
        .slider::-webkit-slider-track {
            background: rgb(226, 232, 240);
            border-radius: 6px;
            height: 8px;
        }
        
        .slider::-moz-range-track {
            background: rgb(226, 232, 240);
            border-radius: 6px;
            height: 8px;
            border: 0;
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Gradient animations */
        .gradient-medical {
            background: linear-gradient(135deg, #3AAFA9 0%, #e0f2fe 25%, #f0fdfa 50%, #3AAFA9 100%);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .dropzone {
                min-height: 200px;
                padding: 1.5rem;
            }
            
            .mode-btn {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            .mode-btn svg {
                width: 1.25rem;
                height: 1.25rem;
            }
            
            .slider {
                height: 12px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            .slider::-moz-range-thumb {
                width: 24px;
                height: 24px;
            }
        }
        
        /* Touch targets */
        @media (hover: none) and (pointer: coarse) {
            .dropzone {
                padding: 2rem 1rem;
                border-width: 3px;
                border-radius: 1rem;
            }
            
            button, .slider, input[type="checkbox"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            .eye-color-btn {
                padding: 1rem;
                min-height: 60px;
            }
            
            .feedback-btn {
                padding: 1rem;
                min-height: 50px;
            }
        }
    </style>
</head>
<body class="min-h-screen gradient-medical font-sans antialiased">
    <div class="container mx-auto px-4 py-4 sm:py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8 sm:mb-12">
            <div class="flex flex-col sm:inline-flex sm:flex-row items-center gap-2 sm:gap-3 mb-4">
                <div class="p-2 sm:p-3 bg-gradient-to-r from-blue-600 to-teal-600 rounded-xl sm:rounded-2xl shadow-lg">
                    <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <h1 class="text-2xl sm:text-4xl font-bold bg-gradient-to-r from-blue-900 via-blue-700 to-teal-700 bg-clip-text text-transparent">
                    Clinical Photo Anonymizer
                </h1>
            </div>
            <p class="text-lg sm:text-xl text-slate-600 max-w-2xl mx-auto leading-relaxed px-4 sm:px-0">
                Professional-grade photo processing for medical aesthetics, ensuring patient privacy while showcasing treatment results.
            </p>
        </div>

        <!-- Mode Selector -->
        <div class="flex justify-center mb-6 sm:mb-8">
            <div class="bg-white rounded-2xl p-2 shadow-lg border border-slate-200 w-full max-w-md sm:max-w-none">
                <div class="flex gap-2 justify-center">
                    <button id="beautifyBtn" class="mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg scale-105 flex-1 sm:flex-initial justify-center text-sm sm:text-base">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                        </svg>
                        <span class="hidden sm:inline">Beautify</span>
                        <span class="sm:hidden">Beauty</span>
                    </button>
                    <button id="anonymizeBtn" class="mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 text-slate-600 hover:text-teal-600 hover:bg-teal-50 flex-1 sm:flex-initial justify-center text-sm sm:text-base">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <span class="hidden sm:inline">Anonymize</span>
                        <span class="sm:hidden">Anonymize</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-xl border border-slate-200 p-4 sm:p-8 mb-6 sm:mb-8">
            <!-- Photo Upload Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
                <!-- Before Photo -->
                <div class="space-y-4">
                    <label class="text-base sm:text-lg font-semibold text-slate-700 flex items-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        </svg>
                        Before Photo
                    </label>
                    <div id="beforeDropzone" class="dropzone border-2 border-dashed border-slate-300 rounded-xl p-4 sm:p-8 text-center cursor-pointer transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/50 min-h-48 sm:min-h-64 flex flex-col justify-center items-center">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-slate-400 mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <h3 class="text-base sm:text-lg font-semibold text-slate-600 mb-2">Upload Before Photo</h3>
                        <p class="text-sm sm:text-base text-slate-500">Tap to select or take photo</p>
                        <input type="file" id="beforeInput" accept="image/*" class="hidden">
                    </div>
                </div>

                <!-- After Photo -->
                <div class="space-y-4">
                    <label class="text-base sm:text-lg font-semibold text-slate-700 flex items-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        </svg>
                        After Photo
                    </label>
                    <div id="afterDropzone" class="dropzone border-2 border-dashed border-slate-300 rounded-xl p-4 sm:p-8 text-center cursor-pointer transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/50 min-h-48 sm:min-h-64 flex flex-col justify-center items-center">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-slate-400 mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <h3 class="text-base sm:text-lg font-semibold text-slate-600 mb-2">Upload After Photo</h3>
                        <p class="text-sm sm:text-base text-slate-500">Tap to select or take photo</p>
                        <input type="file" id="afterInput" accept="image/*" class="hidden">
                    </div>
                </div>
            </div>

            <!-- Treatment Notes -->
            <div class="mb-8">
                <label class="text-lg font-semibold text-slate-700 flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Treatment Notes
                </label>
                <textarea id="notes" placeholder="(Optional) Describe the treatment procedures and expected outcomes. Be specific about the changes that should be visible in the after photo." class="w-full p-4 border-2 border-slate-200 rounded-xl resize-none focus:border-blue-400 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-slate-700" rows="4"></textarea>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8" id="controlsGrid">
                <!-- Anonymize Controls -->
                <div id="anonymizeControls" class="hidden bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <label class="block text-sm font-semibold text-slate-700 mb-4">Anonymization Strength</label>
                    <div class="flex items-center gap-4">
                        <input type="range" min="15" max="100" value="15" class="flex-1 h-2 slider text-teal-600" id="anonymizeStrength">
                        <div class="bg-teal-600 text-white px-3 py-1 rounded-lg text-sm font-bold min-w-12 text-center" id="anonymizeStrengthValue">55</div>
                    </div>
                </div>

                <div id="alignmentVarianceControl" class="hidden bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <label class="block text-sm font-semibold text-slate-700 mb-4">Alignment Variance</label>
                    <div class="flex items-center gap-4">
                        <input type="range" min="5" max="20" value="5" class="flex-1 h-2 slider text-teal-600" id="alignmentVariance">
                        <div class="bg-teal-600 text-white px-3 py-1 rounded-lg text-sm font-bold min-w-12 text-center" id="alignmentVarianceValue">Auto</div>
                    </div>
                </div>

                <!-- Beautify Controls -->
                <div id="beautifyControls" class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <label class="block text-sm font-semibold text-slate-700 mb-4">Beautify Intensity</label>
                    <div class="flex items-center gap-4">
                        <input type="range" min="1" max="10" value="5" class="flex-1 h-2 slider text-blue-600" id="beautifyIntensity">
                        <div class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-bold min-w-12 text-center" id="beautifyIntensityValue">5</div>
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="bg-slate-50 rounded-xl border border-slate-200 mb-8">
                <button id="advancedToggle" class="w-full flex items-center justify-between p-6 text-left hover:bg-slate-100 transition-colors rounded-xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="font-semibold text-slate-700">Advanced Options</span>
                    </div>
                    <svg id="advancedChevron" class="w-5 h-5 text-slate-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div id="advancedContent" class="hidden px-6 pb-6 space-y-6 border-t border-slate-200">
                    <div class="pt-6">
                        <div class="flex items-center gap-3 mb-4">
                            <input id="hairMicroVariation" type="checkbox" checked class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <label for="hairMicroVariation" class="text-sm text-slate-700">Hair micro-variation (allow natural styling differences)</label>
                        </div>

                        <div class="flex items-center gap-3 mb-6">
                            <input id="clothingTypeLock" type="checkbox" checked class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <label for="clothingTypeLock" class="text-sm text-slate-700">Maintain consistent clothing style with natural variation</label>
                        </div>

                        <!-- Eye Color Selection - Only for Anonymize -->
                        <div id="eyeColorSection" class="hidden">
                            <label class="block text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Eye Color Selection
                            </label>
                            <div class="grid grid-cols-3 sm:grid-cols-5 gap-3" id="eyeColorGrid">
                                <button class="eye-color-btn p-3 rounded-lg border-2 border-teal-500 bg-teal-50 text-teal-700 transition-all duration-200 text-sm font-medium" data-color="random">
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-r from-blue-400 to-green-400 mx-auto mb-2"></div>
                                    Random
                                </button>
                                <button class="eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium" data-color="hazel">
                                    <div class="w-6 h-6 rounded-full bg-amber-600 mx-auto mb-2"></div>
                                    Hazel
                                </button>
                                <button class="eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium" data-color="green">
                                    <div class="w-6 h-6 rounded-full bg-green-600 mx-auto mb-2"></div>
                                    Green
                                </button>
                                <button class="eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium" data-color="gray">
                                    <div class="w-6 h-6 rounded-full bg-gray-500 mx-auto mb-2"></div>
                                    Gray
                                </button>
                                <button class="eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium" data-color="brown">
                                    <div class="w-6 h-6 rounded-full bg-amber-900 mx-auto mb-2"></div>
                                    Brown
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                <button id="processButton" class="flex items-center justify-center gap-3 px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold text-base sm:text-lg bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 disabled:bg-slate-300 disabled:text-slate-500 disabled:cursor-not-allowed min-h-[50px] w-full sm:w-auto">
                    <span id="processIcon">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                        </svg>
                    </span>
                    <span id="processText">Run Beautify</span>
                </button>

                <button id="resetButton" class="flex items-center justify-center gap-3 px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold text-base sm:text-lg bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors duration-200 min-h-[50px] w-full sm:w-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Reset
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden bg-white rounded-2xl sm:rounded-3xl shadow-xl border border-slate-200 p-4 sm:p-8">
            
            <!-- Composite Image -->
            <div class="text-center mb-8">
                <img id="compositeImage" alt="Processing Result" class="max-w-full rounded-xl shadow-lg mx-auto">
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 justify-center mb-8">
                <button id="downloadButton" class="flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download Result
                </button>
            </div>

            <!-- JSON Log Viewer -->
            <!-- <div class="bg-slate-50 rounded-xl border border-slate-200 mb-8">
                <button id="jsonToggle" class="w-full flex items-center justify-between p-6 text-left hover:bg-slate-100 transition-colors rounded-xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="font-semibold text-slate-700">Processing Log</span>
                    </div>
                    <svg id="jsonChevron" class="w-5 h-5 text-slate-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div id="jsonContent" class="hidden px-6 pb-6 border-t border-slate-200">
                    <div class="bg-slate-900 rounded-lg p-4 mt-6">
                        <pre id="jsonViewer" class="text-green-400 text-sm overflow-x-auto whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div> -->

            <!-- Feedback Section -->
            <div class="bg-slate-50 rounded-xl border border-slate-200 p-6">
                <h3 class="font-semibold text-slate-700 mb-4">Quality Feedback</h3>
                
                <div class="flex gap-4 mb-4">
                    <button id="thumbsUp" class="feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-200 hover:border-green-300 text-slate-600 transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                        </svg>
                        Excellent
                    </button>
                    <button id="thumbsDown" class="feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-200 hover:border-red-300 text-slate-600 transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405-.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
                        </svg>
                        Needs Improvement
                    </button>
                </div>

                <textarea id="feedbackComment" placeholder="Optional feedback comments..." class="w-full p-3 border-2 border-slate-200 rounded-lg resize-none focus:border-blue-400 focus:ring-4 focus:ring-blue-100 transition-all duration-200" rows="3"></textarea>
            </div>
        </div>
    </div>

    <script>
        // State management
        let currentMode = 'beautify';
        let beforeImage = null;
        let afterImage = null;
        let currentJobId = null;
        let feedbackRating = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateUI();
        });

        function setupEventListeners() {
            // Mode selection
            document.getElementById('beautifyBtn').addEventListener('click', () => setMode('beautify'));
            document.getElementById('anonymizeBtn').addEventListener('click', () => setMode('anonymize'));

            // File uploads
            setupDropzone('beforeDropzone', 'beforeInput');
            setupDropzone('afterDropzone', 'afterInput');

            // Slider updates
            document.getElementById('anonymizeStrength').addEventListener('input', function() {
                document.getElementById('anonymizeStrengthValue').textContent = this.value;
            });

            document.getElementById('alignmentVariance').addEventListener('input', function() {
                document.getElementById('alignmentVarianceValue').textContent = 
                    this.value === '12' ? 'Auto' : this.value;
            });

            document.getElementById('beautifyIntensity').addEventListener('input', function() {
                document.getElementById('beautifyIntensityValue').textContent = this.value;
            });

            // Eye color selection
            document.querySelectorAll('.eye-color-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.eye-color-btn').forEach(b => {
                        b.className = 'eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium';
                    });
                    this.className = 'eye-color-btn p-3 rounded-lg border-2 border-teal-500 bg-teal-50 text-teal-700 transition-all duration-200 text-sm font-medium';
                });
            });

            // Advanced options toggle
            document.getElementById('advancedToggle').addEventListener('click', function() {
                const content = document.getElementById('advancedContent');
                const chevron = document.getElementById('advancedChevron');
                
                content.classList.toggle('hidden');
                chevron.classList.toggle('rotate-180');
            });

            // JSON log toggle - commented out
            // document.getElementById('jsonToggle').addEventListener('click', function() {
            //     const content = document.getElementById('jsonContent');
            //     const chevron = document.getElementById('jsonChevron');
            //     
            //     content.classList.toggle('hidden');
            //     chevron.classList.toggle('rotate-180');
            // });

            // Action buttons
            document.getElementById('processButton').addEventListener('click', processImages);
            document.getElementById('resetButton').addEventListener('click', resetApp);

            // Feedback buttons
            document.getElementById('thumbsUp').addEventListener('click', () => setFeedback('up'));
            document.getElementById('thumbsDown').addEventListener('click', () => setFeedback('down'));
        }

        function setupDropzone(dropzoneId, inputId) {
            const dropzone = document.getElementById(dropzoneId);
            const input = document.getElementById(inputId);

            dropzone.addEventListener('click', () => input.click());
            
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-blue-400', 'bg-blue-50');
                this.classList.remove('border-slate-300');
            });

            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-blue-400', 'bg-blue-50');
                this.classList.add('border-slate-300');
            });

            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-blue-400', 'bg-blue-50');
                this.classList.add('border-slate-300');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0], dropzoneId);
                }
            });

            input.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    handleFileUpload(this.files[0], dropzoneId);
                }
            });
        }

        function handleFileUpload(file, dropzoneId) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload only image files.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (dropzoneId === 'beforeDropzone') {
                    beforeImage = e.target.result;
                } else {
                    afterImage = e.target.result;
                }
                updateDropzonePreview(dropzoneId, e.target.result);
                validateInputs();
            };
            reader.readAsDataURL(file);
        }

        function updateDropzonePreview(dropzoneId, imageSrc) {
            const dropzone = document.getElementById(dropzoneId);
            const isBeforeDropzone = dropzoneId === 'beforeDropzone';
            const title = isBeforeDropzone ? 'Before' : 'After';
            
            // Get image dimensions for display
            const tempImage = new Image();
            tempImage.onload = function() {
                dropzone.innerHTML = `
                    <div class="relative group w-full aspect-[4/3] bg-slate-50 rounded-xl">
                        <img src="${imageSrc}" alt="${title}" class="absolute inset-0 w-full h-full object-contain rounded-xl shadow-md">
                        <button onclick="removeImage('${dropzoneId}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-600 z-10" aria-label="Remove ${title} image">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <div class="absolute bottom-2 left-2 sm:bottom-4 sm:left-4 bg-black/50 text-white px-2 py-1 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-medium">
                            ${title} ✓
                        </div>
                        <div class="absolute top-2 left-2 bg-blue-500/80 text-white px-2 py-1 rounded text-xs">
                            ${this.naturalWidth}×${this.naturalHeight}
                        </div>
                    </div>
                `;
            }
            tempImage.src = imageSrc;
        }

        function removeImage(dropzoneId) {
            const isBefore = dropzoneId === 'beforeDropzone';
            const title = isBefore ? 'Before' : 'After';
            if (isBefore) {
                beforeImage = null;
            } else {
                afterImage = null;
            }

            const dropzone = document.getElementById(dropzoneId);
            dropzone.innerHTML = `
                <svg class="w-10 h-10 sm:w-12 sm:h-12 text-slate-400 mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <h3 class="text-base sm:text-lg font-semibold text-slate-600 mb-2">Upload ${title} Photo</h3>
                <p class="text-sm sm:text-base text-slate-500">Tap to select or take photo</p>
            `;
            validateInputs();
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update mode buttons
            const beautifyBtn = document.getElementById('beautifyBtn');
            const anonymizeBtn = document.getElementById('anonymizeBtn');
            
            if (mode === 'beautify') {
                beautifyBtn.className = 'mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg scale-105 flex-1 sm:flex-initial justify-center text-sm sm:text-base';
                anonymizeBtn.className = 'mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 text-slate-600 hover:text-teal-600 hover:bg-teal-50 flex-1 sm:flex-initial justify-center text-sm sm:text-base';
            } else {
                anonymizeBtn.className = 'mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 bg-gradient-to-r from-teal-600 to-teal-500 text-white shadow-lg scale-105 flex-1 sm:flex-initial justify-center text-sm sm:text-base';
                beautifyBtn.className = 'mode-btn flex items-center gap-3 px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all duration-300 text-slate-600 hover:text-blue-600 hover:bg-blue-50 flex-1 sm:flex-initial justify-center text-sm sm:text-base';
            }

            updateUI();
            validateInputs();
        }

        function updateUI() {
            const isBeautify = currentMode === 'beautify';
            
            // Show/hide controls
            document.getElementById('anonymizeControls').classList.toggle('hidden', isBeautify);
            document.getElementById('alignmentVarianceControl').classList.toggle('hidden', isBeautify);
            document.getElementById('beautifyControls').classList.toggle('hidden', !isBeautify);
            document.getElementById('eyeColorSection').classList.toggle('hidden', isBeautify);

            // Update button appearance and text
            const processButton = document.getElementById('processButton');
            const processIcon = document.getElementById('processIcon');
            const processText = document.getElementById('processText');

            const baseClasses = 'flex items-center justify-center gap-3 px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold text-base sm:text-lg text-white shadow-lg hover:shadow-xl transition-all duration-300 disabled:bg-slate-300 disabled:text-slate-500 disabled:cursor-not-allowed min-h-[50px] w-full sm:w-auto';

            if (isBeautify) {
                processButton.className = `${baseClasses} bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600`;
                processIcon.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                `;
                processText.textContent = 'Run Beautify';
            } else {
                processButton.className = `${baseClasses} bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-700 hover:to-teal-600`;
                processIcon.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                `;
                processText.textContent = 'Run Anonymize';
            }
        }

        function validateInputs() {
            const processBtn = document.getElementById('processButton');
            
            if (currentMode === 'beautify') {
                processBtn.disabled = !(beforeImage && afterImage);
            } else {
                processBtn.disabled = !(beforeImage || afterImage);
            }
        }

        function processImages() {
            const processBtn = document.getElementById('processButton');
            const processIcon = document.getElementById('processIcon');
            const processText = document.getElementById('processText');
            
            // Update button state
            processBtn.disabled = true;
            processIcon.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            `;
            processText.textContent = 'Processing...';

            // Gather form data
            const selectedEyeColor = document.querySelector('.eye-color-btn.border-teal-500')?.dataset.color || 'random';
            
            const payload = {
                mode: currentMode,
                images: {
                    before: beforeImage,
                    after: afterImage
                },
                notes: document.getElementById('notes').value,
                variation: currentMode === 'anonymize' ? parseInt(document.getElementById('anonymizeStrength').value) : undefined,
                beautify_intensity: currentMode === 'beautify' ? parseInt(document.getElementById('beautifyIntensity').value) : undefined,
                alignment_variance: document.getElementById('alignmentVariance').value === '12' ? null : 
                                 parseInt(document.getElementById('alignmentVariance').value),
                advanced: {
                    hair_micro_variation: document.getElementById('hairMicroVariation').checked,
                    clothing_type_lock: document.getElementById('clothingTypeLock').checked,
                    clothing_variation: true,
                    eye_color: currentMode === 'anonymize' ? selectedEyeColor : undefined
                },
                consent_verified: currentMode === 'beautify'
            };

            console.log('Processing payload:', payload);
            
            // Make API call
            fetch('/api/job', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                console.log('Job completed:', data);
                currentJobId = data.job_id;
                showResults(data);
            })
            .catch(error => {
                console.error('Error processing job:', error);
                alert('Error processing images: ' + (error.error || 'Please try again.'));
            })
            .finally(() => {
                // Reset button state
                validateInputs();
                updateUI();
            });
        }

        function showResults(data = null) {
            const compositeImage = document.getElementById('compositeImage');
            
            if (data && data.image_url) {
                // Add a cache-busting query parameter to force reload
                compositeImage.src = `${data.image_url}?t=${new Date().getTime()}`;
                
                // Load JSON log if available
                if (data.json_url) {
                    fetch(`${data.json_url}?t=${new Date().getTime()}`)
                        .then(response => response.json())
                        .then(jsonData => {
                            document.getElementById('jsonViewer').textContent = JSON.stringify(jsonData, null, 2);
                        })
                        .catch(error => {
                            console.error('Error loading JSON log:', error);
                            document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
                        });
                } else {
                    document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
                }
            }

            // Setup download functionality
            const downloadBtn = document.getElementById('downloadButton');
            downloadBtn.onclick = function() {
                const link = document.createElement('a');
                link.download = `clinical-photo-${currentMode}-${currentJobId || Date.now()}.png`;
                link.href = compositeImage.src;
                link.click();
            };
            
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            // Reset feedback
            feedbackRating = null;
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.className = 'feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-200 hover:border-green-300 text-slate-600 transition-all duration-200';
            });
            document.getElementById('feedbackComment').value = '';
        }

        function setFeedback(rating) {
            feedbackRating = rating;
            
            // Update button styles
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.className = 'feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-200 hover:border-green-300 text-slate-600 transition-all duration-200';
            });
            
            const selectedBtn = document.getElementById(rating === 'up' ? 'thumbsUp' : 'thumbsDown');
            if (rating === 'up') {
                selectedBtn.className = 'feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 transition-all duration-200';
            } else {
                selectedBtn.className = 'feedback-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 transition-all duration-200';
            }
            
            // Submit feedback to API
            const feedbackData = {
                job_id: currentJobId,
                rating: rating,
                comment: document.getElementById('feedbackComment').value
            };
            
            if (currentJobId) {
                fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Feedback submitted successfully:', data);
                    // Show brief confirmation
                    const originalText = selectedBtn.querySelector('span').textContent;
                    selectedBtn.querySelector('span').textContent = '✓ Submitted';
                    setTimeout(() => selectedBtn.querySelector('span').textContent = originalText, 1500);
                })
                .catch(error => {
                    console.error('Error submitting feedback:', error);
                    alert('Error submitting feedback. Please try again.');
                });
            }
        }

        function resetApp() {
            beforeImage = null;
            afterImage = null;
            currentJobId = null;
            feedbackRating = null;
            
            // Reset dropzones
            removeImage('beforeDropzone');
            removeImage('afterDropzone');
            
            // Reset form
            document.getElementById('notes').value = '';
            document.getElementById('feedbackComment').value = '';
            
            // Reset sliders
            document.getElementById('anonymizeStrength').value = 55;
            document.getElementById('anonymizeStrengthValue').textContent = '55';
            document.getElementById('alignmentVariance').value = 12;
            document.getElementById('alignmentVarianceValue').textContent = 'Auto';
            document.getElementById('beautifyIntensity').value = 5;
            document.getElementById('beautifyIntensityValue').textContent = '5';
            
            // Reset eye color selection
            document.querySelectorAll('.eye-color-btn').forEach((btn, index) => {
                if (index === 0) {
                    btn.className = 'eye-color-btn p-3 rounded-lg border-2 border-teal-500 bg-teal-50 text-teal-700 transition-all duration-200 text-sm font-medium';
                } else {
                    btn.className = 'eye-color-btn p-3 rounded-lg border-2 border-slate-200 hover:border-slate-300 text-slate-600 transition-all duration-200 text-sm font-medium';
                }
            });
            
            // Hide results
            document.getElementById('resultsSection').classList.add('hidden');
            
            validateInputs();
        }
    </script>
</body>
</html>